<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />

    <link rel="manifest" href="/manifest.json" />
    <link rel="icon" href="/images/icons/icon-152x152.png" />
    <!-- theme-color defines the top bar color-->
    <meta name="theme-color" content="#575757" />
    <meta
      http-equiv="X-Content-Security-Policy"
      content="default-src 'self'; script-src 'report-sample' 'self' https://app.posthog.com/static/array.js https://www.googletagmanager.com/gtag/js; style-src 'report-sample' 'self' https://fonts.googleapis.com; object-src 'none'; base-uri 'self'; connect-src 'self' https://app.posthog.com; font-src 'self'; frame-src 'self'; img-src 'self'; manifest-src 'self'; media-src 'self'; report-uri https://pauldambra.report-uri.com/r/d/csp/enforce; worker-src 'self';"
    />
    <!-- Add to home screen for Safari on iOS-->
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="MiRaNo" />
    <link rel="apple-touch-icon" href="/images/icons/icon-152x152.png" />

    <!-- Add to home screen for Windows-->
    <meta
      name="msapplication-TileImage"
      content="/images/icons/icon-152x152.png"
    />
    <meta name="msapplication-TileColor" content="#575757" />

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>Serverless - Part Two</title>
    <link rel="canonical" href="https://pauldambra.dev/2018/02/serverless-2.html" />
    <meta property="og:url" content="https://pauldambra.dev/2018/02/serverless-2.html" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Serverless - Part Two" />
    <meta
      property="og:description"
      content="Examining event driven serverless systems"
    />
    <meta
      property="og:image"
      content="https://pauldambra.dev/images/cardboard.jpg"
    />
    <meta name="twitter:creator" content="@pauldambra" />
    <meta property="fb:app_id" content="1029758320473951" />

    <meta name="viewport" content="width=device-width" />
    <meta
      name="description"
      content="Examining event driven serverless systems"
    />
    <meta property="fb:pages" content="1029758320473951" />
    <link
      rel="alternate"
      type="application/rss+xml"
      title="Mindless Rambling Nonsense"
      href="https://pauldambra.dev/feed.xml"
    />
    <link rel="shortcut icon" href="/favicon.ico" />

    <link rel="prefetch" href="/images/cardboard.jpg" />

    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/syntax.css">
    <meta name="msvalidate.01" content="54691C3C7B863CEE60F0305D6EDFF7A8" />
    <meta
      name="google-site-verification"
      content="hLKEdujpXNQ9PSZWEcQkwxCgL2z1tWxVedeaUmttH7c"
    />
    <script>
    !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group identify setPersonProperties setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags resetGroups onFeatureFlags addFeatureFlagsHandler onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
    posthog.init('phc_YwZdW7eDzRlzm3YiNvZpAR5oGhmc9nYeVwuUq5mef3b', {
        api_host: 'https://ph.pauldambra.dev',
        defaults: '2026-01-30'
    })
</script>

  </head>
  <body class="flex flex-col h-screen">
    <header class="flex flex-col px-8 pt-4 text-white text-xl" role="banner">
  <div class="flex flex-col sm:flex-row">
    <div class="no-underline hover:underline">
      <a href="/">Mindless Rambling Nonsense</a>
    </div>
    <div class="flex-grow my-2 sm:m-0"></div>
    <div class="flex justify-start items-end flex-col text-sm">
      <div class="flex items-center">
        <div class="mr-4">Paul D'Ambra</div>
        <a href="https://github.com/pauldambra" rel="noopener">
          <img
            src="/images/GitHub-Mark-Light-32px.png"
            alt="pauldambra on github"
            width="32"
            height="32"
          />
        </a>
      </div>
      <div class="flex items-center">
        <div class="mr-4">Fangler</div>
        <a href="https://twitter.com/pauldambra" rel="noopener">
          <img
            src="/images/twitter-32.png"
            alt="pauldambra on twitter"
            width="32"
            height="32"
          />
        </a>
      </div>
      <div class="flex items-center">
        <div class="mr-4"></div>
        <a rel="me" href="https://mastodon.me.uk/@pauldambra">
        </a>
      </div>
    </div>
  </div>
  <div class="flex-grow"></div>
  <div
    class="flex align-middle items-start px-2 py-4 text-white space-x-4 text-lg"
  >
    <nav role="navigation">
      <a class="underline" href="/">Blog Posts</a>
      <a class="underline ml-5" href="/weeknotes.html">Week Notes</a>
      <a class="underline ml-5" href="/kids-games.html">Kids games</a>
    </nav>
  </div>
</header>

    <main role="main" class="bg-white p-4 w-11/12 m-auto flex-auto flex-grow">
      

<script type="application/ld+json">
  {
     "@context":"http://schema.org",
     "@type":"BlogPosting",
     "headline":"Serverless - Part Two",
     "genre":"",
     "keywords":"",
     "wordCount":"2255",
     "url":"https://pauldambra.dev/2018/02/serverless-2.html",
     "datePublished":"2018-02-04",
     "author":{
        "@type":"Person",
        "name":"Paul D'Ambra",
        "sameAs":[
          "https://twitter.com/pauldambra",
          "https://github.com/pauldambra",
          "https://plus.google.com/u/0/+PaulDAmbraPlus"
        ]
     },
     "publisher":{
  "@type": "Organization",
      "name": "Paul D'Ambra",
      "sameAs": [
          "https://twitter.com/pauldambra",
          "https://github.com/pauldambra",
          "https://plus.google.com/u/0/+PaulDAmbraPlus"
      ],
      "logo": {
        "@type": "ImageObject",
        "contentUrl": "https://pauldambra.dev/images/logo.png",
          "url": "https://pauldambra.dev"
      }
     },
     "image":{
        "@type":"ImageObject",
        "contentUrl":"https://pauldambra.dev/images/cardboard.jpg",
        "url":"https://pauldambra.dev",
        "height":"450",
        "width":"1000"
     },
     "mainEntityOfPage":{
        "@type":"WebPage",
        "@id":"https://pauldambra.dev/2018/02/serverless-2.html"
     },
     "articleBody":"After  describing  event-driven  and  serverless  systems  in  part  one  it  is  time  to  write  some  code.  Well,  almost.  The  first  task  is  a  walking  skeleton:  some  code  that  runs  on  production  infrastructure  to  prove  we  could  have  a  CI  pipeline.\n\nI  think  I'll  roll  my  AWS  credentials  pretty  frequently  now  -  since  I  can't  imagine  I'll  get  through  this  series  without  leaking  my  keys  somehow\n\nÂ¯\\_(ãƒ„)_/Â¯\n\nPutting  authentication  and  authorisation  to  one  side,  because  the  chunk  is  too  big  otherwise,  this  task  is  to  write  a  command  channel  to  allow  editors  to  propose  destinations  on  the  visitplannr  system.\n\nThis  requires  the  set  up  of  API  Gateway,  AWS  Lambda,  and  DynamoDB  infrastructure  and  showing  some  code  running.  But  doesn't  require  DynamoDB  table  streams  or  more  than  one  lambda.\n\nThat  feels  like  a  meaningful  slice.\n\n\n\nThe  moving  pieces\n\n\n\nInfrastructure  as  Code\n\nWe  use  terraform  at  work  so  it  would  be  quite  productive  to  use  that  -  but  I  wanted  to  try  out  SAM  local  to  understand  its  local  development  story  and  deployment  using  CloudFormation.\n\nFrom  the  docs:  \"SAM  Local  can  be  used  to  test  functions  locally,  start  a  local  API  Gateway  from  a  SAM  template,  validate  a  SAM  template,  and  generate  sample  payloads  for  various  event  sources.\"\n\nThe  Serverless  Application  Model  or  SAM  is  based  on  CloudFormation.  With  the  aim  of  defining  \"a  standard  application  model  for  serverless  applications\".\n\nCloudFormation  is  an  AWS  specific  infrastructure  as  code  resource  letting  you  author  entire  application  stacks  as  JSON  or  YAML.  That  let's  you  launch  \"application  stacks\",  in  this  case:  API  Gateway,  Lambda,  and  DynamoDB.\n\nCode  as  Code\n\nAWS  lambda  now  runs  many  awesome  languages  (NodeJS,  Python,  C#,  Java,  and  Go).  I  ðŸ’–  JavaScript  and  have  already  experimented  a  few  times  over  the  last  few  years  with  NodeJS  in  Lambda.  So  will  write  the  application  in  Node.\n\nThere  are  a  number  of  frameworks  that  sit  on  top  of  AWS  Lambda  and  API  Gateway.  Such  as  Claudia.js  or  Serverless.  But  I  didn't  want  any  of  the  details  hidden  away  from  me  so  haven't  investigated  them  at  all  (which  may  be  cutting  off  my  arm  to  spite  my  face).\n\nThe  eventstream\n\nIt  is  common  to  use  dynamodb  as  the  storage  mechanism  for  Lambda.  \"Amazon  DynamoDB  is  highly  available,  with  automatic  and  synchronous  data  replication  across  three  facilities  in  an  AWS  Region.\"\n\nWhich  highlights  one  of  the  benefits  of  the  serverless  model  -  geographically  distributed  HA  database  by  default.\n\nIt  can  read  and  write  JSON,  and  allows  you  to  subscribe  to  the  stream  of  changes  for  a  table.  So  most  likely  fits  the  needs  of  this  application.\n\nThe  SAM  template\n\nThe  SAM  template  is  (once  you're  used  to  the  syntax)  pretty  straightforward.\n\nA  header  describing  this  template  and  the  versions  of  the  language  used:\n\nAWSTemplateFormatVersion:  \"2010-09-09\"\nTransform:  AWS::Serverless-2016-10-31\n\nDescription:  |\n    A  location  and  weather  aware  day-trip  planner  for  parents\n\n\na  list  of  the  resources  to  be  created:\n\nResources:\n\n\nA  dynamodb  table  definition:\n\nEventsTable:\n    Type:  \"AWS::DynamoDB::Table\"\n    Properties:\n        AttributeDefinitions:\n            -  AttributeName:  StreamName\n                AttributeType:  S\n            -  AttributeName:  EventId\n                AttributeType:  S\n        KeySchema:\n            -  AttributeName:  StreamName\n                KeyType:  HASH\n            -  AttributeName:  EventId\n                KeyType:  RANGE\n        ProvisionedThroughput:\n            ReadCapacityUnits:  5\n            WriteCapacityUnits:  5\n\n\n\"In  DynamoDB,  tables,  items,  and  attributes  are  the  core  components  that  you  work  with.  A  table  is  a  collection  of  items,  and  each  item  is  a  collection  of  attributes.  DynamoDB  uses  primary  keys  to  uniquely  identify  each  item  in  a  table  and  secondary  indexes  to  provide  more  querying  flexibility.\"\n\nThere  are  two  types  of  primary  key  in  dynamodb.  And  this  is  the  first  design  decision  which  will  need  validation  in  future.  In  fact  in  a  \"real\"  project  this  would  need  a  lightweight  architecture  decision  record.  So  let's  add  one  here.\n\nThe  first  kind  of  primary  key  in  DynamoDB  is  having  only  a  partition  key.  The  partition  key  is  hashed  and  determines  where  on  physical  storage  the  item  is  placed.  The  partition  key  must  be  unique.\n\nThe  second  kind  is  a  composite  primary  key.  It  consists  of  a  partition  key  and  a  sort  key.  The  partition  key  no  longer  needs  to  be  unique  in  isolation.  Rather  the  sort  key/partition  key  pair  must  be  unique.\n\nIn  a  real  system  this  would  probably  push  towards  StreamName  as  the  partition  key:  so  that  events  that  logically  live  together  physically  live  together.  And  EventNumber  in  the  stream  as  the  sort  key.  So  that  the  order  of  items  as  they  are  stored  on  physical  media  matches  the  order  they  are  likely  to  be  read.\n\nThis  would  introduce  a  bunch  of  complexity  in  code  for  tracking  event  numbers  so  for  now  instead  of  an  EventNumber  as  the  sort  key  the  decision  is  to  introduce  a  UUID  EventId.  This  will  need  performance  testing  to  check  that  there  is  no  significant  impact  of  the  items  being  sorted  by  UUID.\n\nThe  \"ProvisionedThroughput\"  setting  show  where  the  abstraction  starts  to  leak  and  the  fact  that  these  services  run  on  infrastructure  bleeds  through.  Under  the  hood  AWS  is  reserving  capacity  for  dynamodb  -  after  all  they  definitely  do  have  to  capacity  plan  their  infrastructure  so  that  we  don't  have  to.\n\nFrom  the  docs:\n\n\"One  read  capacity  unit  =  one  strongly  consistent  read  per  second,  or  two  eventually  consistent  reads  per  second,  for  items  up  to  4  KB  in  size.\n\nOne  write  capacity  unit  =  one  write  per  second,  for  items  up  to  1  KB  in  size.\"\n\nSo  the  system  needs  to  be  sized  against  the  expected  read  and  write  throughput.\n\nThe  AWS  SDK  has  retries  built  in  for  if  the  AWS  service  throttles  your  reads  or  writes  when  you  are  over  capacity.  This  would  be  an  area  that  would  need  testing  and  monitoring  in  a  real  system.\n\nIt's  important  to  note  that  the  \"cost\"  of  managing  that  capacity  setting  is  probably  lower  than  the  cost  of  creating,  managing,  and  maintaining  your  own  distributed,  highly-available,  (potentially)  multi-master  database  cluster.\n\nAnd  worth  saying  that  on  Prime  Day  2017  Amazon's  own  use  of  DynamoDB  peaked  at  nearly  13  million  reads  per  second.  So  the  need  for  throughput  limits  in  config  isn't  because  the  service  can't  cope  with  your  load.\n\nThe  lambda  and  API  gateway  definition:\n\nProposeDestinationFunction:\n    Type:  AWS::Serverless::Function\n    Properties:\n        Runtime:  nodejs6.10\n        Handler:  proposeDestination.handler\n        Timeout:  10\n        Policies:  AmazonDynamoDBFullAccess\n        Environment:\n            Variables:\n                EVENTS_TABLE:  !Ref  EventsTable\n        Events:\n            ProposeDestination:\n                Type:  Api\n                Properties:\n                    Path:  /destination\n                    Method:  POST\n\n\nThis  sets  a  lambda  function  with  a  given  handler,  and  runtime.  The  handler  is  the  code  that  will  run  when  the  event  is  received.  And  sets  an  environment  variable  to  reference  the  created  dynamodb  table.\n\nFinally  sets  that  this  lambda  function  will  be  triggered  by  an  API  POST  to  /destination.  Which  is  all  SAM  needs  in  order  to  create  an  API  gateway  to  trigger  the  lambda.\n\nWith  39  lines  of  YAML  SAM  will  provision  an  API  gateway,  a  lambda  function,  and  a  dynamodb  function.  All  highly  available,  elastic,  and  distributed  geographically  -  that's  pretty  funky!\n\nThe  handler  code\n\nexports.handler  =  (event,  context,  callback)  =&gt;  {\n    console.log(`received  event:  ${JSON.stringify(event)}`);\n    callback(null,  {\n        statusCode:  200,\n        body:  \"OK\",\n    });\n};\n\n\nFirst  things  first:\n\n\n    No  semi-colons.  Live  with  it.  It's  great.\n    standardjs  -  I  don't  agree  with  all  of  standardjs'  decisions  but  I  do  recognise  that  since  they're  largely  arbitrary  I  shouldn't  care.\n\n\nThis  is  a  lambda  function.  It's  about  as  small  a  function  as  you  can  write  to  respond  to  an  event  from  API  gateway.  First  it  logs  the  received  event.  Then  it  tells  API  gateway  to  return  a  http  status  200  with  the  body  'OK'  to  the  client.\n\nAnchors  away!\n\nAfter  incurring  the  incredible  cost  of  $0.02  because  I  kept  forgetting  to  strip  chai  and  mocha  from  the  bundle  I  wrote  a  deployment  script.\n\n\n#!  /bin/bash\n\nset  -eux\n\nrm  -rf  node_modules/\n\nnpm  install  --only=production\n\nif  aws  s3  ls  \"s3://visitplannr\"  2&gt;&amp;1  |  grep  -q  'NoSuchBucket'\nthen\n    aws  s3  mb  s3://visitplannr\nfi\n\nsam  package  --template-file  template.yaml  \\\n    --s3-bucket  visitplannr  \\\n    --output-template-file  packaged.yaml\n\nsam  deploy  --template-file  ./packaged.yaml  \\\n    --stack-name  visitplannr  \\\n    --capabilities  CAPABILITY_IAM\n\n\n\n\n    remove  node_modules  directory\n    npm  install  all  of  the  non-dev  dependencies  (there  aren't  actually  any  yet!)\n    make  sure  there's  an  s3  bucket  to  upload  the  code  into\n    run  sam  package  which  translates  to  CloudFormation  and  uploads  the  code  to  s3\n    run  sam  deploy  which  launches  the  application  stack\n\n\nRunning  that  creates  everything  necessary  in  AWS.  Looking  at  the  created  stack  there  are  more  pieces  created  than  needed  to  be  specified.\n\n\n\nThis  includes  the  IAM  roles  to  allow  these  resources  to  talk  to  each  other.  These  at  least  in  part  result  from  the  config  line:  Policies:  AmazonDynamoDBFullAccess  applied  to  the  lambda  function.\n\nThis  is  much  more  access  than  we  need.  But  in  the  interest  of  not  getting  diverted  the  necessity  for  finer  grained  access  goes  on  the  to-do  list  -  it's  possible  but  not  necessary  right  now.\n\nThe  wider  than  necessary  access  can  be  seen  in  the  lambda  console  which  lists  out  the  resources  the  function  can  access  and  the  policy  that  makes  that  access  possible.\n\n\n\nThe  API  Gateway  console  shows  the  new  endpoint\n\n\n\nThe  endpoint  can  be  tested  right  in  the  console:\n\n\n\nand  the  results  are  logged  in  the  page\n\n\n\nAnd  finally,  the  cloudwatch  logs  show  the  output  from  running  the  lambda.\n\nThat\n\nconsole.log(`received  event:  ${JSON.stringify(event)}`);\n\n\nresults  in  logging:\n\n\n2018-03-04T22:45:26.854Z    bb57cb6c-1ffd-11e8-b4a3-d7ae7c406190    received  event:\n{\n        \"resource\":  \"/destination\",\n        \"path\":  \"/destination\",\n        \"httpMethod\":  \"POST\",\n        \"headers\":  null,\n        \"queryStringParameters\":  null,\n        \"pathParameters\":  null,\n        \"stageVariables\":  null,\n        \"requestContext\":  {\n                \"path\":  \"/destination\",\n                \"accountId\":  \"123456\",\n                \"resourceId\":  \"0yfso6\",\n                \"stage\":  \"test-invoke-stage\",\n                \"requestId\":  \"test-invoke-request\",\n                \"identity\":  {\n                        \"apiKeyId\":  \"test-invoke-api-key-id\",\n                        \"userAgent\":  \"Apache-HttpClient/4.5.x  (Java/1.8.0_144)\",\n                        \"snip\":  \"much  more  info\"\n                },\n                \"resourcePath\":  \"/destination\",\n                \"httpMethod\":  \"POST\",\n                \"apiId\":  \"lvcba3r3ia\"\n        },\n        \"body\":  \"{\\n        \\\"test\\\":  \\\"this  endpoint\\\"\\n}\",\n        \"isBase64Encoded\":  false\n}\n\n\n\nand  each  invocation  also  logs  a  line  like:\n\nREPORT  RequestId:  bb57cb6c-1ffd-11e8-b4a3-d7ae7c406190    Duration:  15.92  ms    Billed  Duration:  100  ms  Memory  Size:  128  MB  Max  Memory  Used:  20  MB\n\nShowing  you  the  actual  and  billed  durations  and  the  used  memory  compared  to  the  provisioned  memory.\n\nMore  leaky  abstractions\n\nSo,  it  isn't  that  you  don't  have  to  care  at  all  that  there  are  servers.  AWS  Lambda  charges  per  100ms  of  function  invocation.  The  amount  of  time  you  get  for  free  and  the  cost  per  100ms  varies  depending  on  how  much  RAM  you  allocate  to  the  function.\n\nIn  fact,  increasing  the  RAM  actually  increases  the  underlying  compute,  network,  threads,  and  more.  In  some  experiments  at  Co-op  Digital  we  saw  that  scaling  for  a  network  and  compute  bound  workload  was  pretty  important.\n\nDynamoDB\n\n\n\nThe  table  has  been  created  and  is  ready  to  be  used.  The  config  we've  used  doesn't  actually  setup  the  table  for  autoscaling.  But  we'll  loop  back  around  and  tidy  that  up  later.  It's  another  detail  that  doesn't  need  nailing  right  now.\n\nLet's  review\n\nWith  39  lines  of  YAML  we've  created  a  walking  skeleton  to  prove  we  can  write  code  locally  and  deploy  it  to  AWS.\n\nWe've  had  to  learn  a  little  about  the  details  of  dynamodb  and  AWS  lambda  where  they  leak  their  underlying  infrastructure  into  our  worlds  -  although  presumably  there's  a  setting  equivalent  to  \"I  care  less  about  how  much  I  spend  than  how  much  resource  you  use  -  charge  me  what  you  like  and  don't  bother  me  again\".  I  don't  want  to  turn  that  on  (yet).\n\nAll  the  code  for  this  stage  can  be  found  on  github\n\nAnd  we're  finally  ready  to  write  some  tests.  In  the  next  post  we'll  look  at  some  tests,  talk  about  the  final  state  of  the  handler,  and  look  at  how  to  set  up  locally  to  run  integration  tests.\n\nAnd  delete\n\naws  cloudformation  delete-stack  --stack-name  visitplannr  &amp;&amp;  aws  s3  rb  s3://visitplannr  --force\n\nThis  tells  AWS  to  delete  everything  since  I  don't  want  to  pay  money  for  an  application  stack  that  nobody  is  using  and  only  exists  for  my  (unashamedly  very  low  readership)  blog.\n"
  }
</script>

<article>
<header class="flex flex-col border-b-black border-b-2 bg-white text-black">
  <div class="heading">
    <div class="date">Sun Feb 04 2018</div>
    <h1 class="title leading-10 pt-2 mb-0 mt-1">Serverless - Part Two</h1>
  </div>
  <div class="meta flex-grow flex flex-row">
    <div class="share-this flex self-end space-x-2">
      <a
        id="facebook-share-link"
        class="social-share"
        target="_blank"
        rel="noopener"
        href="https://www.facebook.com/dialog/share?app_id=305449093152216&href=https://pauldambra.dev/2018/02/serverless-2.html"
      >
        <img
          class="w-8"
          src="/images/facebook-black-32.png"
          alt="share on facebook"
          width="32"
          height="32"
        />
      </a>
      <a
        id="twitter-share-link"
        class="social-share"
        target="_blank"
        rel="noopener"
        href="https://twitter.com/intent/tweet?text=Serverless+-+Part+Two&via=pauldambra&url=https://pauldambra.dev/2018/02/serverless-2.html"
      >
        <img
          class="w-8"
          src="/images/twitter-black-32.png"
          alt="share on twitter"
          width="32"
          height="32"
        />
      </a>
    </div>
    <div class="more-like-this text-right content-end flex-grow">
      <a
        class="post-metadata"
        href="/categories.html#serverless"
      >
        in: serverless
      </a>
      <div>
<span class="text-slate-500">
  <img class="w-6 h-6 inline-block" src="/images/tag.svg" alt="tag-icon" />
  <a class="no-underline hover:underline" href="/tags.html#serverless">
    serverless
  </a>
</span>

<span class="text-slate-500">
  <img class="w-6 h-6 inline-block" src="/images/tag.svg" alt="tag-icon" />
  <a class="no-underline hover:underline" href="/tags.html#series">
    series
  </a>
</span>

<span class="text-slate-500">
  <img class="w-6 h-6 inline-block" src="/images/tag.svg" alt="tag-icon" />
  <a class="no-underline hover:underline" href="/tags.html#events">
    events
  </a>
</span>

<span class="text-slate-500">
  <img class="w-6 h-6 inline-block" src="/images/tag.svg" alt="tag-icon" />
  <a class="no-underline hover:underline" href="/tags.html#eventdriven">
    eventdriven
  </a>
</span>

</div>
    </div>
  </div>
</header>

	<div class="post">
		<p>After describing event-driven and serverless systems in <a href="/2018/02/serverless-1.html">part one</a> it is time to write some code. Well, almost. The first task is a <a href="http://alistair.cockburn.us/Walking+skeleton">walking skeleton</a>: some code that runs on production infrastructure to prove we could have a CI pipeline.</p>

<p>I think I'll roll my AWS credentials pretty frequently now - since I can't imagine I'll get through this series without leaking my keys somehow</p>

<p><code class="language-plaintext highlighter-rouge">Â¯\_(ãƒ„)_/Â¯</code></p>

<p>Putting authentication and authorisation to one side, because the chunk is too big otherwise, this task is to write a command channel to allow editors to propose destinations on the <code class="language-plaintext highlighter-rouge">visitplannr</code> system.</p>

<p>This requires the set up of API Gateway, AWS Lambda, and DynamoDB infrastructure and showing some code running. But doesn't require DynamoDB table streams or more than one lambda.</p>

<p>That feels like a meaningful slice.</p>

<!--more-->

<h1 id="the-moving-pieces">The moving pieces</h1>

<p><img src="/images/first-slice-2.jpg" alt="the second level of a c4 diagram" loading="lazy" /></p>

<h2 id="infrastructure-as-code">Infrastructure as Code</h2>

<p>We use terraform at work so it would be quite productive to use that - but I wanted to try out <a href="https://github.com/awslabs/aws-sam-local">SAM local</a> to understand its local development story and deployment using CloudFormation.</p>

<p>From <a href="https://github.com/awslabs/aws-sam-local/blob/28eacbdd299917b2cceeb9444fe22bd57d33d97d/README.md">the docs</a>: "SAM Local can be used to test functions locally, start a local API Gateway from a SAM template, validate a SAM template, and generate sample payloads for various event sources."</p>

<p>The <a href="https://github.com/awslabs/serverless-application-model">Serverless Application Model or SAM</a> is based on CloudFormation. With the aim of defining "a standard application model for serverless applications".</p>

<p><a href="https://aws.amazon.com/cloudformation/">CloudFormation</a> is an AWS specific infrastructure as code resource letting you author entire application stacks as JSON or YAML. That let's you launch "application stacks", in this case: API Gateway, Lambda, and DynamoDB.</p>

<h2 id="code-as-code">Code as Code</h2>

<p>AWS lambda now runs many awesome languages (NodeJS, Python, C#, Java, and Go). I ðŸ’– JavaScript and have already experimented a few times over the last few years with NodeJS in Lambda. So will write the application in Node.</p>

<p>There are a number of frameworks that sit on top of AWS Lambda and API Gateway. Such as <a href="https://claudiajs.com/">Claudia.js</a> or <a href="https://serverless.com/">Serverless</a>. But I didn't want any of the details hidden away from me so haven't investigated them at all (which may be cutting off my arm to spite my face).</p>

<h2 id="the-eventstream">The eventstream</h2>

<p>It is common to use <a href="https://aws.amazon.com/dynamodb/">dynamodb</a> as the storage mechanism for Lambda. "Amazon DynamoDB is highly available, with automatic and synchronous data replication across three facilities in an AWS Region."</p>

<p>Which highlights one of the benefits of the serverless model - geographically distributed HA database by default.</p>

<p>It can read and write JSON, and allows you to subscribe to the stream of changes for a table. So most likely fits the needs of this application.</p>

<h1 id="the-sam-template">The SAM template</h1>

<p><a href="https://github.com/pauldambra/visit-plannr/blob/9bb8c9d392a1352d5d1e51f34e1a04700b9a20e9/template.yaml">The SAM template</a> is (once you're used to the syntax) pretty straightforward.</p>

<p>A header describing this template and the versions of the language used:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">AWSTemplateFormatVersion</span><span class="pi">:</span> <span class="s2">"</span><span class="s">2010-09-09"</span>
<span class="na">Transform</span><span class="pi">:</span> <span class="s">AWS::Serverless-2016-10-31</span>

<span class="na">Description</span><span class="pi">:</span> <span class="pi">|</span>
  <span class="s">A location and weather aware day-trip planner for parents</span>
</code></pre></div></div>

<p>a list of the resources to be created:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">Resources</span><span class="pi">:</span>
</code></pre></div></div>

<h2 id="a-dynamodb-table-definition">A dynamodb table definition:</h2>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">EventsTable</span><span class="pi">:</span>
  <span class="na">Type</span><span class="pi">:</span> <span class="s2">"</span><span class="s">AWS::DynamoDB::Table"</span>
  <span class="na">Properties</span><span class="pi">:</span>
    <span class="na">AttributeDefinitions</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">AttributeName</span><span class="pi">:</span> <span class="s">StreamName</span>
        <span class="na">AttributeType</span><span class="pi">:</span> <span class="s">S</span>
      <span class="pi">-</span> <span class="na">AttributeName</span><span class="pi">:</span> <span class="s">EventId</span>
        <span class="na">AttributeType</span><span class="pi">:</span> <span class="s">S</span>
    <span class="na">KeySchema</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">AttributeName</span><span class="pi">:</span> <span class="s">StreamName</span>
        <span class="na">KeyType</span><span class="pi">:</span> <span class="s">HASH</span>
      <span class="pi">-</span> <span class="na">AttributeName</span><span class="pi">:</span> <span class="s">EventId</span>
        <span class="na">KeyType</span><span class="pi">:</span> <span class="s">RANGE</span>
    <span class="na">ProvisionedThroughput</span><span class="pi">:</span>
      <span class="na">ReadCapacityUnits</span><span class="pi">:</span> <span class="m">5</span>
      <span class="na">WriteCapacityUnits</span><span class="pi">:</span> <span class="m">5</span>
</code></pre></div></div>

<p>"<a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/HowItWorks.CoreComponents.html">In DynamoDB, tables, items, and attributes are the core components that you work with. A table is a collection of items, and each item is a collection of attributes. DynamoDB uses primary keys to uniquely identify each item in a table and secondary indexes to provide more querying flexibility.</a>"</p>

<p>There are two types of primary key in dynamodb. And this is the first design decision which will need validation in future. In fact in a "real" project this would need a <a href="http://thinkrelevance.com/blog/2011/11/15/documenting-architecture-decisions">lightweight architecture decision record</a>. So let's add one <a href="https://github.com/pauldambra/visit-plannr/blob/0d563ec26c7fd7920c1da5f1e67d1f70693016d5/doc/ladr/0002-dynamodb-composite-primary-key-design.md">here</a>.</p>

<p>The first kind of primary key in DynamoDB is having only a partition key. The partition key is hashed and determines where on physical storage the item is placed. The partition key must be unique.</p>

<p>The second kind is a composite primary key. It consists of a partition key and a sort key. The partition key no longer needs to be unique in isolation. Rather the sort key/partition key pair must be unique.</p>

<p>In a real system this would probably push towards StreamName as the partition key: so that events that logically live together physically live together. And EventNumber in the stream as the sort key. So that the order of items as they are stored on physical media matches the order they are likely to be read.</p>

<p>This would introduce a bunch of complexity in code for tracking event numbers so for now instead of an EventNumber as the sort key the decision is to introduce a UUID EventId. This will need performance testing to check that there is no significant impact of the items being sorted by UUID.</p>

<p>The "ProvisionedThroughput" setting show where the abstraction starts to leak and the fact that these services run on infrastructure bleeds through. Under the hood AWS is reserving capacity for dynamodb - after all <em>they</em> definitely do have to capacity plan their infrastructure so that we don't have to.</p>

<p><a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Limits.html">From the docs</a>:</p>

<p>"One read capacity unit = one strongly consistent read per second, or two eventually consistent reads per second, for items up to 4 KB in size.</p>

<p>One write capacity unit = one write per second, for items up to 1 KB in size."</p>

<p>So the system needs to be sized against the expected read and write throughput.</p>

<p>The AWS SDK has retries built in for <em>if</em> the AWS service throttles your reads or writes when you are over capacity. This would be an area that would need testing and monitoring in a real system.</p>

<p>It's important to note that the "cost" of managing that capacity setting is probably lower than the cost of creating, managing, and maintaining your own distributed, highly-available, (potentially) multi-master database cluster.</p>

<p>And worth saying that on Prime Day 2017 <a href="https://twitter.com/pauldambra/status/968504223158734849">Amazon's own use of DynamoDB peaked at nearly 13 million reads per second</a>. So the need for throughput limits in config isn't because the service can't cope with <em>your</em> load.</p>

<h2 id="the-lambda-and-api-gateway-definition">The lambda <em>and</em> API gateway definition:</h2>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">ProposeDestinationFunction</span><span class="pi">:</span>
  <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::Serverless::Function</span>
  <span class="na">Properties</span><span class="pi">:</span>
    <span class="na">Runtime</span><span class="pi">:</span> <span class="s">nodejs6.10</span>
    <span class="na">Handler</span><span class="pi">:</span> <span class="s">proposeDestination.handler</span>
    <span class="na">Timeout</span><span class="pi">:</span> <span class="m">10</span>
    <span class="na">Policies</span><span class="pi">:</span> <span class="s">AmazonDynamoDBFullAccess</span>
    <span class="na">Environment</span><span class="pi">:</span>
      <span class="na">Variables</span><span class="pi">:</span>
        <span class="na">EVENTS_TABLE</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">EventsTable</span>
    <span class="na">Events</span><span class="pi">:</span>
      <span class="na">ProposeDestination</span><span class="pi">:</span>
        <span class="na">Type</span><span class="pi">:</span> <span class="s">Api</span>
        <span class="na">Properties</span><span class="pi">:</span>
          <span class="na">Path</span><span class="pi">:</span> <span class="s">/destination</span>
          <span class="na">Method</span><span class="pi">:</span> <span class="s">POST</span>
</code></pre></div></div>

<p>This sets a lambda function with a given handler, and runtime. The handler is the code that will run when the event is received. And sets an environment variable to reference the created dynamodb table.</p>

<p>Finally sets that this lambda function will be triggered by an API POST to /destination. Which is all SAM needs in order to create an API gateway to trigger the lambda.</p>

<p>With 39 lines of YAML SAM will provision an API gateway, a lambda function, and a dynamodb function. All highly available, elastic, and distributed geographically - that's pretty funky!</p>

<h1 id="the-handler-code">The handler code</h1>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">exports</span><span class="p">.</span><span class="nx">handler</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">`received event: </span><span class="p">${</span><span class="nx">JSON</span><span class="p">.</span><span class="nf">stringify</span><span class="p">(</span><span class="nx">event</span><span class="p">)}</span><span class="s2">`</span><span class="p">);</span>
  <span class="nf">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">statusCode</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
    <span class="na">body</span><span class="p">:</span> <span class="dl">"</span><span class="s2">OK</span><span class="dl">"</span><span class="p">,</span>
  <span class="p">});</span>
<span class="p">};</span>
</code></pre></div></div>

<p>First things first:</p>

<ul>
  <li>No semi-colons. Live with it. It's great.</li>
  <li><a href="https://standardjs.com/">standardjs</a> - I don't agree with all of standardjs' decisions but I do recognise that since they're largely arbitrary I shouldn't care.</li>
</ul>

<p>This is a <a href="https://docs.aws.amazon.com/lambda/latest/dg/nodejs-prog-model-handler.html">lambda function</a>. It's about as small a function as you can write to respond to an event from API gateway. First it logs the received event. Then it tells API gateway to return a http status 200 with the body 'OK' to the client.</p>

<h1 id="anchors-away">Anchors away!</h1>

<p>After incurring the incredible cost of $0.02 because I kept forgetting to strip chai and mocha from the bundle I wrote a deployment script.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c">#! /bin/bash</span>

<span class="nb">set</span> <span class="nt">-eux</span>

<span class="nb">rm</span> <span class="nt">-rf</span> node_modules/

npm <span class="nb">install</span> <span class="nt">--only</span><span class="o">=</span>production

<span class="k">if </span>aws s3 <span class="nb">ls</span> <span class="s2">"s3://visitplannr"</span> 2&gt;&amp;1 | <span class="nb">grep</span> <span class="nt">-q</span> <span class="s1">'NoSuchBucket'</span>
<span class="k">then
  </span>aws s3 mb s3://visitplannr
<span class="k">fi

</span>sam package <span class="nt">--template-file</span> template.yaml <span class="se">\</span>
  <span class="nt">--s3-bucket</span> visitplannr <span class="se">\</span>
  <span class="nt">--output-template-file</span> packaged.yaml

sam deploy <span class="nt">--template-file</span> ./packaged.yaml <span class="se">\</span>
  <span class="nt">--stack-name</span> visitplannr <span class="se">\</span>
  <span class="nt">--capabilities</span> CAPABILITY_IAM

</code></pre></div></div>

<ul>
  <li>remove node_modules directory</li>
  <li>npm install all of the non-dev dependencies (there aren't actually any yet!)</li>
  <li>make sure there's an s3 bucket to upload the code into</li>
  <li>run <code class="language-plaintext highlighter-rouge">sam package</code> which translates to CloudFormation and uploads the code to s3</li>
  <li>run <code class="language-plaintext highlighter-rouge">sam deploy</code> which launches the application stack</li>
</ul>

<p>Running that creates everything necessary in AWS. Looking at the created stack there are more pieces created than needed to be specified.</p>

<p><img src="/images/stack.png" alt="the created resources" loading="lazy" /></p>

<p>This includes the IAM roles to allow these resources to talk to each other. These at least in part result from the config line: <code class="language-plaintext highlighter-rouge">Policies: AmazonDynamoDBFullAccess</code> applied to the lambda function.</p>

<p>This is <em>much more</em> access than we need. But in the interest of not getting diverted the necessity for finer grained access goes on the to-do list - it's possible but not necessary right now.</p>

<p>The wider than necessary access can be seen in the lambda console which lists out the resources the function can access and the policy that makes that access possible.</p>

<p><img src="/images/lambda-console.png" alt="the lambda console and its permissions" loading="lazy" /></p>

<p>The API Gateway console shows the new endpoint</p>

<p><img src="/images/api-gateway.png" alt="the api gateway console" loading="lazy" /></p>

<p>The endpoint can be tested right in the console:</p>

<p><img src="/images/testing-api-1.png" alt="testing the api" loading="lazy" /></p>

<p>and the results are logged in the page</p>

<p><img src="/images/testing-api-result-2.png" alt="the api test results" loading="lazy" /></p>

<p>And finally, the cloudwatch logs show the output from running the lambda.</p>

<p>That</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">`received event: </span><span class="p">${</span><span class="nx">JSON</span><span class="p">.</span><span class="nf">stringify</span><span class="p">(</span><span class="nx">event</span><span class="p">)}</span><span class="s2">`</span><span class="p">);</span>
</code></pre></div></div>

<p>results in logging:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
2018-03-04T22:45:26.854Z  bb57cb6c-1ffd-11e8-b4a3-d7ae7c406190  received event:
{
    "resource": "/destination",
    "path": "/destination",
    "httpMethod": "POST",
    "headers": null,
    "queryStringParameters": null,
    "pathParameters": null,
    "stageVariables": null,
    "requestContext": {
        "path": "/destination",
        "accountId": "123456",
        "resourceId": "0yfso6",
        "stage": "test-invoke-stage",
        "requestId": "test-invoke-request",
        "identity": {
            "apiKeyId": "test-invoke-api-key-id",
            "userAgent": "Apache-HttpClient/4.5.x (Java/1.8.0_144)",
            "snip": "much more info"
        },
        "resourcePath": "/destination",
        "httpMethod": "POST",
        "apiId": "lvcba3r3ia"
    },
    "body": "{\n    \"test\": \"this endpoint\"\n}",
    "isBase64Encoded": false
}

</code></pre></div></div>

<p>and each invocation also logs a line like:</p>

<p><code class="language-plaintext highlighter-rouge">REPORT RequestId: bb57cb6c-1ffd-11e8-b4a3-d7ae7c406190  Duration: 15.92 ms  Billed Duration: 100 ms Memory Size: 128 MB Max Memory Used: 20 MB</code></p>

<p>Showing you the actual and billed durations and the used memory compared to the provisioned memory.</p>

<h1 id="more-leaky-abstractions">More leaky abstractions</h1>

<p>So, it isn't that you don't have to care <em>at all</em> that there are servers. AWS Lambda charges per 100ms of function invocation. <a href="https://aws.amazon.com/lambda/pricing/">The amount of time you get for free and the cost per 100ms varies depending on how much RAM you allocate to the function</a>.</p>

<p>In fact, increasing the RAM actually increases the underlying compute, network, threads, and more. In some experiments at Co-op Digital we saw that scaling for a network and compute bound workload was pretty important.</p>

<h1 id="dynamodb">DynamoDB</h1>

<p><img src="/images/dynamo-console.png" alt="The table viewed in the AWS console" loading="lazy" /></p>

<p>The table has been created and is ready to be used. The config we've used doesn't actually setup the table for autoscaling. But we'll loop back around and tidy that up later. It's another detail that doesn't need nailing right now.</p>

<h1 id="lets-review">Let's review</h1>

<p>With 39 lines of YAML we've created a walking skeleton to prove we can write code locally and deploy it to AWS.</p>

<p>We've had to learn a little about the details of dynamodb and AWS lambda where they leak their underlying infrastructure into our worlds - although presumably there's a setting equivalent to "I care less about how much I spend than how much resource you use - charge me what you like and don't bother me again". I don't want to turn that on (yet).</p>

<p>All the code for this stage can be found <a href="https://github.com/pauldambra/visit-plannr/tree/code-blog-post-part-two">on github</a></p>

<p>And we're <strong>finally</strong> ready to write some tests. In the next post we'll look at some tests, talk about the final state of the handler, and look at how to set up locally to run integration tests.</p>

<h1 id="and-delete">And delete</h1>

<p><code class="language-plaintext highlighter-rouge">aws cloudformation delete-stack --stack-name visitplannr &amp;&amp; aws s3 rb s3://visitplannr --force</code></p>

<p>This tells AWS to delete everything since I don't want to pay money for an application stack that nobody is using and only exists for my (unashamedly very low readership) blog.</p>

	</div>
	<div class="mt-8">
  
  <h1>More like this...</h1>
   
  <div class="grid grid-cols-3 gap-4"> <a href="/2019/11/serverless-lessons-learned.html">
  <div class="article-tile inline-block w-full border p-4 text-ellipsis align-top relative">
      <h3>
        Serverless - Lessons learned
      </h3>
      <small>
        30 Nov 2019
      </small>
  </div>
</a>  <a href="/2018/07/serverless-6.html">
  <div class="article-tile inline-block w-full border p-4 text-ellipsis align-top relative">
      <h3>
        Serverless - Part Six - Making a view
      </h3>
      <small>
        01 Jul 2018
      </small>
  </div>
</a>  <a href="/2018/06/serverless-5.html">
  <div class="article-tile inline-block w-full border p-4 text-ellipsis align-top relative">
      <h3>
        Serverless - Part Five - Read Models
      </h3>
      <small>
        10 Jun 2018
      </small>
  </div>
</a> </div> 
  
</div>

</article>
    </main>
    <footer class="w-full h-4 bg-black text-white py-8 px-4">
  <a class="no-underline text-white" href="https://pauldambra.dev/feed.xml">
    <img class="inline w-6 h-6" src="/images/rss.svg" alt="the rss feed" />
    <span>Subscribe to RSS feed</span>
  </a>
</footer>
 
    <script>
      var tsl = document.getElementById("twitter-share-link");
      tsl.addEventListener("click", function () {
        ga("send", {
          hitType: "social",
          socialNetwork: "twitter",
          socialAction: "tweet",
          socialTarget: "https://pauldambra.dev/2018/02/serverless-2.html",
        });
      });

      var fsl = document.getElementById("facebook-share-link");
      fsl.addEventListener("click", function () {
        ga("send", {
          hitType: "social",
          socialNetwork: "facebook",
          socialAction: "share",
          socialTarget: "https://pauldambra.dev/2018/02/serverless-2.html",
        });
      });
    </script>
    

    <script defer src="/register-service-worker.js"></script>

    <link
      href="https://fonts.googleapis.com/css?family=Khula&display=swap"
      rel="stylesheet"
    />
  </body>
</html>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />

    <link rel="manifest" href="/manifest.json" />
    <link rel="icon" href="/images/icons/icon-152x152.png" />
    <!-- theme-color defines the top bar color-->
    <meta name="theme-color" content="#575757" />
    <meta
      http-equiv="X-Content-Security-Policy"
      content="default-src 'self'; script-src 'report-sample' 'self' https://app.posthog.com/static/array.js https://www.googletagmanager.com/gtag/js; style-src 'report-sample' 'self' https://fonts.googleapis.com; object-src 'none'; base-uri 'self'; connect-src 'self' https://app.posthog.com; font-src 'self'; frame-src 'self'; img-src 'self'; manifest-src 'self'; media-src 'self'; report-uri https://pauldambra.report-uri.com/r/d/csp/enforce; worker-src 'self';"
    />
    <!-- Add to home screen for Safari on iOS-->
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="MiRaNo" />
    <link rel="apple-touch-icon" href="/images/icons/icon-152x152.png" />

    <!-- Add to home screen for Windows-->
    <meta
      name="msapplication-TileImage"
      content="/images/icons/icon-152x152.png"
    />
    <meta name="msapplication-TileColor" content="#575757" />

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>Websites != CMS Platform - Better Editable Affordance with JS for great good</title>
    <link rel="canonical" href="https://pauldambra.dev/better-affordance-js.html" />
    <meta property="og:url" content="https://pauldambra.dev/better-affordance-js.html" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Websites != CMS Platform - Better Editable Affordance with JS for great good" />
    <meta
      property="og:description"
      content="using funky js magic to make a better visual affordance"
    />
    <meta
      property="og:image"
      content="https://pauldambra.dev/images/cardboard.jpg"
    />
    <meta name="twitter:creator" content="@pauldambra" />
    <meta property="fb:app_id" content="1029758320473951" />

    <meta name="viewport" content="width=device-width" />
    <meta
      name="description"
      content="using funky js magic to make a better visual affordance"
    />
    <meta property="fb:pages" content="1029758320473951" />
    <link
      rel="alternate"
      type="application/rss+xml"
      title="Mindless Rambling Nonsense"
      href="https://pauldambra.dev/feed.xml"
    />
    <link rel="shortcut icon" href="/favicon.ico" />

    <link rel="prefetch" href="/images/cardboard.jpg" />

    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/syntax.css">
    <meta name="msvalidate.01" content="54691C3C7B863CEE60F0305D6EDFF7A8" />
    <meta
      name="google-site-verification"
      content="hLKEdujpXNQ9PSZWEcQkwxCgL2z1tWxVedeaUmttH7c"
    />
    <script>
    !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init Ce Ls Ns Te As js capture Xe calculateEventProperties qs register register_once register_for_session unregister unregister_for_session Gs getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSurveysLoaded onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey canRenderSurveyAsync identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty Hs Us createPersonProfile Ws Os Js opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing get_explicit_consent_status is_capturing clear_opt_in_out_capturing zs debug L Bs getPageViewId captureTraceFeedback captureTraceMetric".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
    posthog.init('phc_pDm161Kiiwh2GfpX1ELnmaMafhvp2EIDYFlWo8f12PK', {
        api_host: 'https://ph.pauldambra.dev',
        ui_host: 'https://ph.pauldambra.dev',
        defaults: '2025-05-24',
        person_profiles: 'identified_only', // or 'always' to create profiles for anonymous users as well
    })
</script>

  </head>
  <body class="flex flex-col h-screen">
    <header class="flex flex-col px-8 pt-4 text-white text-xl" role="banner">
  <div class="flex flex-col sm:flex-row">
    <div class="no-underline hover:underline">
      <a href="/">Mindless Rambling Nonsense</a>
    </div>
    <div class="flex-grow my-2 sm:m-0"></div>
    <div class="flex justify-start items-end flex-col text-sm">
      <div class="flex items-center">
        <div class="mr-4">Paul D'Ambra</div>
        <a href="https://github.com/pauldambra" rel="noopener">
          <img
            src="/images/GitHub-Mark-Light-32px.png"
            alt="pauldambra on github"
            width="32"
            height="32"
          />
        </a>
      </div>
      <div class="flex items-center">
        <div class="mr-4">Fangler</div>
        <a href="https://twitter.com/pauldambra" rel="noopener">
          <img
            src="/images/twitter-32.png"
            alt="pauldambra on twitter"
            width="32"
            height="32"
          />
        </a>
      </div>
      <div class="flex items-center">
        <div class="mr-4"></div>
        <a rel="me" href="https://mastodon.me.uk/@pauldambra">
        </a>
      </div>
    </div>
  </div>
  <div class="flex-grow"></div>
  <div
    class="flex align-middle items-start px-2 py-4 text-white space-x-4 text-lg"
  >
    <nav role="navigation">
      <a class="underline" href="/">Blog Posts</a>
      <a class="underline ml-5" href="/weeknotes.html">Week Notes</a>
      <a class="underline ml-5" href="/kids-games.html">Kids games</a>
    </nav>
  </div>
</header>

    <main role="main" class="bg-white p-4 w-11/12 m-auto flex-auto flex-grow">
      

<script type="application/ld+json">
  {
     "@context":"http://schema.org",
     "@type":"BlogPosting",
     "headline":"Websites != CMS Platform - Better Editable Affordance with JS for great good",
     "genre":"",
     "keywords":"",
     "wordCount":"1696",
     "url":"https://pauldambra.dev/better-affordance-js.html",
     "datePublished":"2014-07-30",
     "author":{
        "@type":"Person",
        "name":"Paul D'Ambra",
        "sameAs":[
          "https://twitter.com/pauldambra",
          "https://github.com/pauldambra",
          "https://plus.google.com/u/0/+PaulDAmbraPlus"
        ]
     },
     "publisher":{
  "@type": "Organization",
      "name": "Paul D'Ambra",
      "sameAs": [
          "https://twitter.com/pauldambra",
          "https://github.com/pauldambra",
          "https://plus.google.com/u/0/+PaulDAmbraPlus"
      ],
      "logo": {
        "@type": "ImageObject",
        "contentUrl": "https://pauldambra.dev/images/logo.png",
          "url": "https://pauldambra.dev"
      }
     },
     "image":{
        "@type":"ImageObject",
        "contentUrl":"https://pauldambra.dev/images/cardboard.jpg",
        "url":"https://pauldambra.dev",
        "height":"450",
        "width":"1000"
     },
     "mainEntityOfPage":{
        "@type":"WebPage",
        "@id":"https://pauldambra.dev/better-affordance-js.html"
     },
     "articleBody":"This  post  is  part  of  a  series  where  I'm  hoping  to  prove  to  myself  that  building  a  dynamic  website  with  NodeJS  is  much  more  fun  than  using  a  CMS  platform.  See  the  first  post  for  an  explanation  of  why\n\nThe  code  can  be  found  on  GitHub\n\nPrevious  Post\n\n\n\nIn  the  last  post  a  better  visual  affordance  that  a  page  element  is  editable  was  added.  But  didn't  solve  the  problem  that  notifications  of  success  or  failure  were  obtrusive  and  disconnected  from  the  edited  element.\n\n\n\n\n\n\nThe  desired  behaviour  is  that  when  a  change  is  made  the  entire  current  page  is  persisted  to  the  server  and  the  user  is  made  aware  of  success  or  failure  without  interrupting  their  workflow  unnecessarily.\n\n\n\nSo  here  as  the  text  is  changed  the  indicator  changes  to  the  save  icon.  On  success  to  a  tick  and  after  a  short  delay  back  to  the  editable  icon.\n\nBut  how?!\n\nChanging  the  icon\n\nThe  actual  switch  is\n\n(function  (omniclopse)  {\n    \"use  strict\";\n\n    omniclopse.ux  =  omniclopse.ux  ||  {};\n\n    var  switchIcons  =  function  (element,  oldClass,  newClass)  {\n        element.classList.remove(oldClass);\n        element.classList.add(newClass);\n    };\n\n    omniclopse.ux.saveContentStarted  =  function  (element)  {\n        switchIcons(element,  \"fa-pencil\",  \"fa-save\");\n    };\n\n    omniclopse.ux.saveContentCompleted  =  function  (element)  {\n        switchIcons(element,  \"fa-save\",  \"fa-check\");\n        setTimeout(function  ()  {\n            switchIcons(element,  \"fa-check\",  \"fa-pencil\");\n        },  3000);\n    };\n\n    omniclopse.ux.saveContentFailed  =  function  (element)  {\n        switchIcons(element,  \"fa-save\",  \"fa-times\");\n    };\n})((window.omniclopse  =  window.omniclopse  ||  {}));\n\n\nSince  the  site  is  using  the  well-named  Font-awesome  icon  library  all  that  is  needed  to  change  the  icon  is  to  alter  the  fa  classes  on  the  element.\n\nAs  an  exercise  in  hipsterism  this  is  done  with  vanilla  javascript  but  it  would  be  trivial  to  pass  JQuery  into  this  IIFE  and  use  the  class  addition  and  removal  functions  it  provides  instead.\n\nSo,\n\n\n    when  saving  content  has  started  the  pencil  icon  is  switched  out  for  a  save  icon\n    when  saving  completes  the  save  icon  is  switched  for  a  check  and  timeout  is  set  to  switch  that  check  back  to  the  original  pencil\n    when  saving  fails  the  save  icon  is  switched  for  an  X.\n\n\nRight  now  this  behaviour  on  fail  is  pretty  rubbish  as  the  user  doesn't  get  an  error  message  and  there's  no  way  to  retry.  Really  hovering  over  or  clicking  on  the  X  should  display  the  error  message.  The  icon  should  change  to  a  retry  symbol  or  clicking  on  it  should  prompt  for  retry  and  the  page  should  use  localstorage  so  that  your  edits  aren't  lost.  But  that's  for  another  day!\n\nWiring  it  up\n\n(function  (omniclopse,  $)  {\n    \"use  strict\";\n\n    var  getEditableElementsForUpload  =  function  ()  {\n        return  $(\".panel\")\n            .map(function  (index,  el)  {\n                var  title  =  $(el).find(\"h1\");\n                var  body  =  $(el).find(\".panel-body\");\n                return  {\n                    title:  title  ?  title.text()  :  \"\",\n                    body:  body  ?  body.html()  :  \"\",\n                };\n            })\n            .get();\n    };\n\n    omniclopse.onContentEdited  =  function  (element)  {\n        var  icon  =  $(element).find(\"i\")[0];\n\n        omniclopse.ux.saveContentStarted(icon);\n        var  panels  =  getEditableElementsForUpload();\n\n        var  putData  =  {  panels:  panels  };\n        $.ajax({\n            url:  \"/pages/home\",\n            dataType:  \"json\",\n            contentType:  \"application/json\",\n            data:  JSON.stringify(putData),\n            type:  \"PUT\",\n        })\n            .fail(function  (xhr,  status)  {\n                omniclopse.ux.saveContentFailed(icon);\n            })\n            .done(function  ()  {\n                omniclopse.ux.saveContentCompleted(icon);\n            });\n    };\n})((window.omniclopse  =  window.omniclopse  ||  {}),  $);\n\n\nWhen  the  onContentEdited  event  is  fired  for  an  element\n\n\n    the  child  i  element  which  holds  the  editable  indicator  is  found\n    the  parts  of  the  page  that  need  to  be  persisted  are  gathered\n    saveContentStarted  is  called\n    the  jquery.ajax  method  is  used  to  persist  the  page  (yes,  with  a  hardcoded  URL  this  is  a  work-in-progress  after  all)\n    the  ajax  methods  fail  and  done  promises  are  associated  with  the  saveContentFailed  and  saveContentCompleted  methods  respectively\n\n\nThis  did  need  a  slight  change  to  the  JS  that  watches  for  changes  to  the  page  that  was  introduced  in  a  previous  article\n\n(function  (omniclopse,  $,  ckedit)  {\n    \"use  strict\";\n\n    //shamelessly  borrowed  from  http://stackoverflow.com/a/14027188/222163\n    omniclopse.bindEvents  =  function  ()  {\n        var  before;\n        var  timer;\n        $(\"*[contenteditable]\")\n            .on(\"focus\",  function  ()  {\n                before  =  $(this).html();\n            })\n            .on(\"keyup  paste\",  function  ()  {\n                if  (before  !=  $(this).html())  {\n                    clearTimeout(timer);\n                    var  el  =  $(this)[0];\n                    timer  =  setTimeout(function  ()  {\n                        omniclopse.onContentEdited(el);\n                    },  500);\n                }\n            });\n\n        //ckeditor  replaces  content  when  it  inits  against  an  element  -  yay\n        ckedit.on(\"instanceReady\",  function  (e)  {\n            $(e.editor.element.$).append(\n                '&lt;i  class=\"fa  fa-pencil  editable-affordance\"&gt;&lt;/i&gt;'\n            );\n        });\n    };\n})((window.omniclopse  =  window.omniclopse  ||  {}),  $,  CKEDITOR);\n\n\nThis  now  adds  the  i  child  element  which  indicates  that  a  particular  element  is  editable  which  is  necessary  because  of  how  ckeditor  alters  the  DOM  when  it  picks  up  on  a  contenteditable  element.\n\nAnd,  rather  than  calling  omniclopse.onContentEdited  it  now  passes  in  the  page  element  that  triggered  the  event  so  its  editable  indicator  can  be  updated.\n\nThe  result\n\nis  a  pretty,  funky,  pulsing  indicator  that  shows  an  element  is  editable  and  changes  state  with  the  element  to  keep  the  user  informed  of  what  is  happening  in  the  background.\n\n\n\nDoh-stscript\n\na  postscript  but  also  doh\n\nThe  eagle-eyed  will  notice  a  difference  between  the  first  example  gif  of  the  end  result  and  this  one.  Which  is  the  result  of  a  bug  I  introduced.\n\n\n\nThe  code  above  which  actually  fires  the  onContentEdited  event  uses  a  timeout  so  that  the  event  doesn't  fire  until  after  content  has  finished  changing.\n\nIn  the  original  version  it  looked  like  timer  =  setTimeout(omniclopse.onContentEdited,  500);  which  says  call  the  omniclopse.onContentEdited  event  after  500  milliseconds.\n\nWhen  I  had  to  pass  in  the  element  so  its  state  could  be  updated  I  made  the  simplest  (and  stupidest)  change  possible  so  that  the  line  of  code  now  read  timer  =  setTimeout(omniclopse.onContentEdited($(this)[0]),  500);\n\nEven  without  viewing  these  side-by-side  JS  ninjas  might  see  what  I  did…\n\ntimer  =  setTimeout(omniclopse.onContentEdited,  500);\ntimer  =  setTimeout(omniclopse.onContentEdited($(this)[0]),  500);\n\n\nBecause  the  second  version  has  brackets  against  the  function  name  JS  evaluates  the  function  as  soon  as  it  parses  it  which  isn't  what  we  want  to  happen.\n\nThis  is  definitely  what  qualifies  as  an  ID-10T  problem.\n\nWhat  this  meant  was  as  soon  as  the  HTML  changed  and  even  while  the  user  is  still  typing  the  system  starts  to  update.  That  wasn't  the  desired  behaviour!\n\nThis  code  should  read  (as  it  does  above)…\n\nvar  el  =  $(this)[0];\ntimer  =  setTimeout(function  ()  {\n    omniclopse.onContentEdited(el);\n},  500);\n\n\nThis  now  captures  the  element  that  is  being  edited  in  the  el  variable  and  then  passes  a  function  to  setTimeout  which  when  SetTimeout  actually  runs  calls  onContentEdited.\n\nThe  even  more  eagle-eyed  will  notice  I've  stopped  bothering  to  write  tests  for  these  little  bits  of  JS  and  now  I'm  introducing  bugs  by  changing  old  bits  of  code.  Who  could  have  guessed?!\n"
  }
</script>

<article>
<header class="flex flex-col border-b-black border-b-2 bg-white text-black">
  <div class="heading">
    <div class="date">Wed Jul 30 2014</div>
    <h1 class="title leading-10 pt-2 mb-0 mt-1">Websites != CMS Platform - Better Editable Affordance with JS for great good</h1>
  </div>
  <div class="meta flex-grow flex flex-row">
    <div class="share-this flex self-end space-x-2">
      <a
        id="facebook-share-link"
        class="social-share"
        target="_blank"
        rel="noopener"
        href="https://www.facebook.com/dialog/share?app_id=305449093152216&href=https://pauldambra.dev/better-affordance-js.html"
      >
        <img
          class="w-8"
          src="/images/facebook-black-32.png"
          alt="share on facebook"
          width="32"
          height="32"
        />
      </a>
      <a
        id="twitter-share-link"
        class="social-share"
        target="_blank"
        rel="noopener"
        href="https://twitter.com/intent/tweet?text=Websites+%21%3D+CMS+Platform+-+Better+Editable+Affordance+with+JS+for+great+good&via=pauldambra&url=https://pauldambra.dev/better-affordance-js.html"
      >
        <img
          class="w-8"
          src="/images/twitter-black-32.png"
          alt="share on twitter"
          width="32"
          height="32"
        />
      </a>
    </div>
    <div class="more-like-this text-right content-end flex-grow">
      <a
        class="post-metadata"
        href="/categories.html#cms"
      >
        in: cms
      </a>
      <div>
<span class="text-slate-500">
  <img class="w-6 h-6 inline-block" src="/images/tag.svg" alt="tag-icon" />
  <a class="no-underline hover:underline" href="/tags.html#learning">
    learning
  </a>
</span>

<span class="text-slate-500">
  <img class="w-6 h-6 inline-block" src="/images/tag.svg" alt="tag-icon" />
  <a class="no-underline hover:underline" href="/tags.html#cms">
    cms
  </a>
</span>

<span class="text-slate-500">
  <img class="w-6 h-6 inline-block" src="/images/tag.svg" alt="tag-icon" />
  <a class="no-underline hover:underline" href="/tags.html#design">
    design
  </a>
</span>

<span class="text-slate-500">
  <img class="w-6 h-6 inline-block" src="/images/tag.svg" alt="tag-icon" />
  <a class="no-underline hover:underline" href="/tags.html#web">
    web
  </a>
</span>

<span class="text-slate-500">
  <img class="w-6 h-6 inline-block" src="/images/tag.svg" alt="tag-icon" />
  <a class="no-underline hover:underline" href="/tags.html#series">
    series
  </a>
</span>

</div>
    </div>
  </div>
</header>

	<div class="post">
		<p>This post is part of a series where I'm hoping to prove to myself that building a dynamic website with NodeJS is much more fun than using a CMS platform. <a href="/2014/02/websites-cms.html">See the first post for an explanation of why</a></p>

<p>The code can be found on <a href="https://github.com/pauldambra/omniclopse">GitHub</a></p>

<p><a href="/better-affordance.html">Previous Post</a></p>

<!--alex ignore failure --->

<p>In the last post a better visual affordance that a page element is editable was added. But didn't solve the problem that notifications of success or failure were obtrusive and disconnected from the edited element.</p>

<p><img src="/images/pulse.gif" alt="pulsing affordance" loading="lazy" /></p>

<!--more-->
<!--alex ignore failure --->

<p>The desired behaviour is that when a change is made the entire current page is persisted to the server and the user is made aware of success or failure without interrupting their workflow unnecessarily.</p>

<p><img src="/images/affordance-with-state.gif" alt="Editable indicator changing state" loading="lazy" /></p>

<p>So here as the text is changed the indicator changes to the save icon. On success to a tick and after a short delay back to the editable icon.</p>

<p>But how?!</p>

<h1 id="changing-the-icon">Changing the icon</h1>

<p>The actual switch is</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">function </span><span class="p">(</span><span class="nx">omniclopse</span><span class="p">)</span> <span class="p">{</span>
  <span class="dl">"</span><span class="s2">use strict</span><span class="dl">"</span><span class="p">;</span>

  <span class="nx">omniclopse</span><span class="p">.</span><span class="nx">ux</span> <span class="o">=</span> <span class="nx">omniclopse</span><span class="p">.</span><span class="nx">ux</span> <span class="o">||</span> <span class="p">{};</span>

  <span class="kd">var</span> <span class="nx">switchIcons</span> <span class="o">=</span> <span class="nf">function </span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">oldClass</span><span class="p">,</span> <span class="nx">newClass</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">element</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="nx">oldClass</span><span class="p">);</span>
    <span class="nx">element</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nx">newClass</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">omniclopse</span><span class="p">.</span><span class="nx">ux</span><span class="p">.</span><span class="nx">saveContentStarted</span> <span class="o">=</span> <span class="nf">function </span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">switchIcons</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="dl">"</span><span class="s2">fa-pencil</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">fa-save</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">omniclopse</span><span class="p">.</span><span class="nx">ux</span><span class="p">.</span><span class="nx">saveContentCompleted</span> <span class="o">=</span> <span class="nf">function </span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">switchIcons</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="dl">"</span><span class="s2">fa-save</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">fa-check</span><span class="dl">"</span><span class="p">);</span>
    <span class="nf">setTimeout</span><span class="p">(</span><span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
      <span class="nf">switchIcons</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="dl">"</span><span class="s2">fa-check</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">fa-pencil</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">},</span> <span class="mi">3000</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">omniclopse</span><span class="p">.</span><span class="nx">ux</span><span class="p">.</span><span class="nx">saveContentFailed</span> <span class="o">=</span> <span class="nf">function </span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">switchIcons</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="dl">"</span><span class="s2">fa-save</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">fa-times</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">})((</span><span class="nb">window</span><span class="p">.</span><span class="nx">omniclopse</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">omniclopse</span> <span class="o">||</span> <span class="p">{}));</span>
</code></pre></div></div>

<p>Since the site is using the well-named <a href="http://fontawesome.github.io/Font-Awesome/">Font-awesome icon library</a> all that is needed to change the icon is to alter the fa classes on the element.</p>

<p>As an exercise in hipsterism this is done with <a href="http://vanilla-js.com/">vanilla javascript</a> but it would be trivial to pass JQuery into this IIFE and use the class addition and removal functions it provides instead.</p>

<p>So,</p>

<ul>
  <li>when saving content has started the pencil icon is switched out for a save icon</li>
  <li>when saving completes the save icon is switched for a check and timeout is set to switch that check back to the original pencil</li>
  <li>when saving fails the save icon is switched for an X.</li>
</ul>

<p>Right now this behaviour on fail is pretty rubbish as the user doesn't get an error message and there's no way to retry. Really hovering over or clicking on the X should display the error message. The icon should change to a retry symbol or clicking on it should prompt for retry and the page should use localstorage so that your edits aren't lost. But that's for another day!</p>

<h1 id="wiring-it-up">Wiring it up</h1>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">function </span><span class="p">(</span><span class="nx">omniclopse</span><span class="p">,</span> <span class="nx">$</span><span class="p">)</span> <span class="p">{</span>
  <span class="dl">"</span><span class="s2">use strict</span><span class="dl">"</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">getEditableElementsForUpload</span> <span class="o">=</span> <span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">.panel</span><span class="dl">"</span><span class="p">)</span>
      <span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="nf">function </span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">el</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">title</span> <span class="o">=</span> <span class="nf">$</span><span class="p">(</span><span class="nx">el</span><span class="p">).</span><span class="nf">find</span><span class="p">(</span><span class="dl">"</span><span class="s2">h1</span><span class="dl">"</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">body</span> <span class="o">=</span> <span class="nf">$</span><span class="p">(</span><span class="nx">el</span><span class="p">).</span><span class="nf">find</span><span class="p">(</span><span class="dl">"</span><span class="s2">.panel-body</span><span class="dl">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="p">{</span>
          <span class="na">title</span><span class="p">:</span> <span class="nx">title</span> <span class="p">?</span> <span class="nx">title</span><span class="p">.</span><span class="nf">text</span><span class="p">()</span> <span class="p">:</span> <span class="dl">""</span><span class="p">,</span>
          <span class="na">body</span><span class="p">:</span> <span class="nx">body</span> <span class="p">?</span> <span class="nx">body</span><span class="p">.</span><span class="nf">html</span><span class="p">()</span> <span class="p">:</span> <span class="dl">""</span><span class="p">,</span>
        <span class="p">};</span>
      <span class="p">})</span>
      <span class="p">.</span><span class="nf">get</span><span class="p">();</span>
  <span class="p">};</span>

  <span class="nx">omniclopse</span><span class="p">.</span><span class="nx">onContentEdited</span> <span class="o">=</span> <span class="nf">function </span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">icon</span> <span class="o">=</span> <span class="nf">$</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nf">find</span><span class="p">(</span><span class="dl">"</span><span class="s2">i</span><span class="dl">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>

    <span class="nx">omniclopse</span><span class="p">.</span><span class="nx">ux</span><span class="p">.</span><span class="nf">saveContentStarted</span><span class="p">(</span><span class="nx">icon</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">panels</span> <span class="o">=</span> <span class="nf">getEditableElementsForUpload</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">putData</span> <span class="o">=</span> <span class="p">{</span> <span class="na">panels</span><span class="p">:</span> <span class="nx">panels</span> <span class="p">};</span>
    <span class="nx">$</span><span class="p">.</span><span class="nf">ajax</span><span class="p">({</span>
      <span class="na">url</span><span class="p">:</span> <span class="dl">"</span><span class="s2">/pages/home</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">dataType</span><span class="p">:</span> <span class="dl">"</span><span class="s2">json</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">contentType</span><span class="p">:</span> <span class="dl">"</span><span class="s2">application/json</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">data</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">stringify</span><span class="p">(</span><span class="nx">putData</span><span class="p">),</span>
      <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">PUT</span><span class="dl">"</span><span class="p">,</span>
    <span class="p">})</span>
      <span class="p">.</span><span class="nf">fail</span><span class="p">(</span><span class="nf">function </span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">omniclopse</span><span class="p">.</span><span class="nx">ux</span><span class="p">.</span><span class="nf">saveContentFailed</span><span class="p">(</span><span class="nx">icon</span><span class="p">);</span>
      <span class="p">})</span>
      <span class="p">.</span><span class="nf">done</span><span class="p">(</span><span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">omniclopse</span><span class="p">.</span><span class="nx">ux</span><span class="p">.</span><span class="nf">saveContentCompleted</span><span class="p">(</span><span class="nx">icon</span><span class="p">);</span>
      <span class="p">});</span>
  <span class="p">};</span>
<span class="p">})((</span><span class="nb">window</span><span class="p">.</span><span class="nx">omniclopse</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">omniclopse</span> <span class="o">||</span> <span class="p">{}),</span> <span class="nx">$</span><span class="p">);</span>
</code></pre></div></div>

<p>When the onContentEdited event is fired for an element</p>

<ul>
  <li>the child i element which holds the editable indicator is found</li>
  <li>the parts of the page that need to be persisted are gathered</li>
  <li>saveContentStarted is called</li>
  <li>the jquery.ajax method is used to persist the page (yes, with a hardcoded URL this is a work-in-progress after all)</li>
  <li>the ajax methods fail and done promises are associated with the saveContentFailed and saveContentCompleted methods respectively</li>
</ul>

<p>This did need a slight change to the JS that watches for changes to the page that was introduced <a href="/On-Page-Editing.html#edit-event-js">in a previous article</a></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">function </span><span class="p">(</span><span class="nx">omniclopse</span><span class="p">,</span> <span class="nx">$</span><span class="p">,</span> <span class="nx">ckedit</span><span class="p">)</span> <span class="p">{</span>
  <span class="dl">"</span><span class="s2">use strict</span><span class="dl">"</span><span class="p">;</span>

  <span class="c1">//shamelessly borrowed from http://stackoverflow.com/a/14027188/222163</span>
  <span class="nx">omniclopse</span><span class="p">.</span><span class="nx">bindEvents</span> <span class="o">=</span> <span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">before</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">timer</span><span class="p">;</span>
    <span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">*[contenteditable]</span><span class="dl">"</span><span class="p">)</span>
      <span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">focus</span><span class="dl">"</span><span class="p">,</span> <span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">before</span> <span class="o">=</span> <span class="nf">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nf">html</span><span class="p">();</span>
      <span class="p">})</span>
      <span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">keyup paste</span><span class="dl">"</span><span class="p">,</span> <span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">before</span> <span class="o">!=</span> <span class="nf">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nf">html</span><span class="p">())</span> <span class="p">{</span>
          <span class="nf">clearTimeout</span><span class="p">(</span><span class="nx">timer</span><span class="p">);</span>
          <span class="kd">var</span> <span class="nx">el</span> <span class="o">=</span> <span class="nf">$</span><span class="p">(</span><span class="k">this</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
          <span class="nx">timer</span> <span class="o">=</span> <span class="nf">setTimeout</span><span class="p">(</span><span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">omniclopse</span><span class="p">.</span><span class="nf">onContentEdited</span><span class="p">(</span><span class="nx">el</span><span class="p">);</span>
          <span class="p">},</span> <span class="mi">500</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>

    <span class="c1">//ckeditor replaces content when it inits against an element - yay</span>
    <span class="nx">ckedit</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">instanceReady</span><span class="dl">"</span><span class="p">,</span> <span class="nf">function </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nf">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">editor</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">$</span><span class="p">).</span><span class="nf">append</span><span class="p">(</span>
        <span class="dl">'</span><span class="s1">&lt;i class="fa fa-pencil editable-affordance"&gt;&lt;/i&gt;</span><span class="dl">'</span>
      <span class="p">);</span>
    <span class="p">});</span>
  <span class="p">};</span>
<span class="p">})((</span><span class="nb">window</span><span class="p">.</span><span class="nx">omniclopse</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">omniclopse</span> <span class="o">||</span> <span class="p">{}),</span> <span class="nx">$</span><span class="p">,</span> <span class="nx">CKEDITOR</span><span class="p">);</span>
</code></pre></div></div>

<p>This now adds the i child element which indicates that a particular element is editable which is necessary because of how ckeditor alters the DOM when it picks up on a contenteditable element.</p>

<p>And, rather than calling <code class="language-plaintext highlighter-rouge">omniclopse.onContentEdited</code> it now passes in the page element that triggered the event so its editable indicator can be updated.</p>

<h1 id="the-result">The result</h1>

<p>is a pretty, funky, pulsing indicator that shows an element is editable and changes state with the element to keep the user informed of what is happening in the background.</p>

<p><img src="/images/affordance-with-delay.gif" alt="editable indicator changing state after typing finishes" loading="lazy" /></p>

<h1 id="doh-stscript">Doh-stscript</h1>

<h2 id="a-postscript-but-also-doh">a postscript but also doh</h2>

<p>The eagle-eyed will notice a difference between the first example gif of the end result and this one. Which is the result of a bug I introduced.</p>

<!--alex ignore fires --->

<p>The code above which actually fires the onContentEdited event uses a timeout so that the event doesn't fire until after content has finished changing.</p>

<p>In the original version it looked like <code class="language-plaintext highlighter-rouge">timer = setTimeout(omniclopse.onContentEdited, 500);</code> which says call the <code class="language-plaintext highlighter-rouge">omniclopse.onContentEdited</code> event after 500 milliseconds.</p>

<p>When I had to pass in the element so its state could be updated I made the simplest (and stupidest) change possible so that the line of code now read <code class="language-plaintext highlighter-rouge">timer = setTimeout(omniclopse.onContentEdited($(this)[0]), 500);</code></p>

<p>Even without viewing these side-by-side JS ninjas might see what I did…</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">timer</span> <span class="o">=</span> <span class="nf">setTimeout</span><span class="p">(</span><span class="nx">omniclopse</span><span class="p">.</span><span class="nx">onContentEdited</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
<span class="nx">timer</span> <span class="o">=</span> <span class="nf">setTimeout</span><span class="p">(</span><span class="nx">omniclopse</span><span class="p">.</span><span class="nf">onContentEdited</span><span class="p">(</span><span class="nf">$</span><span class="p">(</span><span class="k">this</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">500</span><span class="p">);</span>
</code></pre></div></div>

<p>Because the second version has brackets against the function name JS evaluates the function as soon as it parses it which isn't what we want to happen.</p>

<p>This is definitely what qualifies as an <a href="http://en.wikipedia.org/wiki/User_error">ID-10T</a> problem.</p>

<p>What this meant was as soon as the HTML changed and even while the user is still typing the system starts to update. That wasn't the desired behaviour!</p>

<p>This code should read (as it does above)…</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">el</span> <span class="o">=</span> <span class="nf">$</span><span class="p">(</span><span class="k">this</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="nx">timer</span> <span class="o">=</span> <span class="nf">setTimeout</span><span class="p">(</span><span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">omniclopse</span><span class="p">.</span><span class="nf">onContentEdited</span><span class="p">(</span><span class="nx">el</span><span class="p">);</span>
<span class="p">},</span> <span class="mi">500</span><span class="p">);</span>
</code></pre></div></div>

<p>This now captures the element that is being edited in the <code class="language-plaintext highlighter-rouge">el</code> variable and then passes a function to setTimeout which <em>when SetTimeout actually runs</em> calls onContentEdited.</p>

<p>The even more eagle-eyed will notice I've stopped bothering to write tests for these little bits of JS and now I'm introducing bugs by changing old bits of code. Who could have guessed?!</p>

	</div>
	<div class="mt-8">
  
  <h1>More like this...</h1>
   
  <div class="grid grid-cols-3 gap-4"> <a href="/wrapping_up.html">
  <div class="article-tile inline-block w-full border p-4 text-ellipsis align-top relative">
      <h3>
        Websites != CMS Platform - Wrapping Up
      </h3>
      <small>
        03 Aug 2014
      </small>
  </div>
</a>  <a href="/better-affordance.html">
  <div class="article-tile inline-block w-full border p-4 text-ellipsis align-top relative">
      <h3>
        Websites != CMS Platform - Better Editable Affordance
      </h3>
      <small>
        20 Jul 2014
      </small>
  </div>
</a>  <a href="/On-Page-Editing.html">
  <div class="article-tile inline-block w-full border p-4 text-ellipsis align-top relative">
      <h3>
        Websites != CMS Platform - On Page Editing
      </h3>
      <small>
        11 Jun 2014
      </small>
  </div>
</a> </div> 
  
</div>

</article>
    </main>
    <footer class="w-full h-4 bg-black text-white py-8 px-4">
  <a class="no-underline text-white" href="https://pauldambra.dev/feed.xml">
    <img class="inline w-6 h-6" src="/images/rss.svg" alt="the rss feed" />
    <span>Subscribe to RSS feed</span>
  </a>
</footer>
 
    <script>
      var tsl = document.getElementById("twitter-share-link");
      tsl.addEventListener("click", function () {
        ga("send", {
          hitType: "social",
          socialNetwork: "twitter",
          socialAction: "tweet",
          socialTarget: "https://pauldambra.dev/better-affordance-js.html",
        });
      });

      var fsl = document.getElementById("facebook-share-link");
      fsl.addEventListener("click", function () {
        ga("send", {
          hitType: "social",
          socialNetwork: "facebook",
          socialAction: "share",
          socialTarget: "https://pauldambra.dev/better-affordance-js.html",
        });
      });
    </script>
    

    <script defer src="/register-service-worker.js"></script>

    <link
      href="https://fonts.googleapis.com/css?family=Khula&display=swap"
      rel="stylesheet"
    />
  </body>
</html>
